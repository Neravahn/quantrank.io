<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>quantrank.io - dashboard</title>

    <style>
        @font-face {
            font-family: 'JotiOne';
            src: url("{{ url_for('static', filename='fonts/JotiOne-Regular.ttf') }}") format('truetype');
        }

        @font-face {
            font-family: 'Nunito';
            src: url("{{ url_for('static', filename='fonts/Nunito-VariableFont_wght.ttf') }}") format('truetype');
        }

        @font-face {
            font-family: 'Bungee';
            src: url("{{ url_for('static', filename='fonts/Bungee-Regular.ttf') }}") format('truetype');
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Nunito';
        }

        body {
            background: black;
            color: white;
        }

        nav {
            width: 100%;
            height: 70px;
            background: #000000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 35px;
            border-bottom: 1px solid #222;
        }

        #logo h3 {
            font-size: 26px;
            font-family: 'JotiOne';
        }

        #logo hi {
            color: rgb(255, 183, 0);
            font-family: 'JotiOne';
        }

        #nav-center {
            display: flex;
            gap: 30px;
        }

        #nav-center a {
            text-decoration: none;
            color: #bfbfbf;
            transition: 0.2s;
        }

        #nav-center a:hover {
            color: rgb(255, 183, 0);
        }

        #main_area {
            margin: 20px auto;
            width: 100%;
            display: flex;
            gap: 20px;
            height: 550px;
            border: 2px solid #15151500;
        }

        #right_area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        #top_stats {
            display: flex;
            gap: 20px;
            height: 500px;
        }

        #piechart {
            border: 1px solid #00000000;
            width: 500px;
            background: #000000;
            height: 500px;
        }

        #leaderboard_area {
            border: 2px solid #15151500;
            width: 500px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-height: 500px;
            overflow-y: auto;
            padding-bottom: 10px;
        }

        .leaderboard_card {
            border-radius: 8px;
            background: rgb(19, 19, 19);
            color: #ffffff;
            font-size: 18px;
            margin: 8px 0;
            height: 75px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            border: 0.5px solid #151515;
            transition: all 0.25s ease;
            width: 90%;
            margin-top: 10px;
        }


        #leaderboard_area::-webkit-scrollbar {
            width: 6px;
        }

        #leaderboard_area::-webkit-scrollbar-track {
            background: #0f0f0f;
            border-radius: 10px;
        }

        #leaderboard_area::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 10px;
        }

        #leaderboard_area::-webkit-scrollbar-thumb:hover {
            background: rgb(255, 183, 0);
        }


        #analysis {
            border: 2px solid #151515;
            width: 675px;
            border-radius: 12px;
            margin-left: 20px;
        }

        #heatmap {
            display: inline-block;
            background: #000;
            border-radius: 12px;
            border: 2px solid #15151500;
            width: 700px;
            margin-top: 5px;
            ;
        }

        #stats_areaU {
            border: 2px solid #15151500;
            border-radius: 12px;
            margin-bottom: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 700px;
            margin-left: 100px;
            height: 800px;
            padding: 20px;
        }

        navhi {
            color: rgb(255, 183, 0);
        }


        #heatmap_canvas {
            display: block;
        }

        #heatmap_txt {
            margin-bottom: 5px;
        }

        #logo_leader {
            font-family: 'Bungee';
            font-size: 2rem;
            color: rgb(206, 206, 206);
            margin-top: 20px;
            letter-spacing: 2px;
        }

        .info_card {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            background: rgb(19, 19, 19);
            border: 2px solid #151515;
            border-radius: 8px;
            padding: 10px 20px;
            margin: 5px 0;
            width: 50%;
            color: #ffffff;
            font-size: 16px;
            gap: 10px;
        }

        .info_card img {
            filter: invert(1);
            width: 24px;
            height: 24px;
        }

        #heatmap_text {
            margin-top: 30px;
            font-size: 16px;
        }

        #profile_pic {
            display: flex;
            align-items: center;
        }

        #profile_pic img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }

        time {
            color: rgb(255, 183, 0);
        }

        #chapters_area {
            width: 90%;
            margin: 10px auto;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            text-align: center;

        }

        #chapters_area h3 {
            font-family: 'Bungee';
            font-size: 2rem;
            color: rgb(206, 206, 206);
            margin-top: 20px;
            letter-spacing: 2px;
        }

        .chapter_card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgb(19, 19, 19);
            border: 2px solid #151515;
            border-radius: 12px;
            padding: 10px 20px;
            color: #ffffff;
            font-size: 18px;
            transition: 0.2s;
            height: 70px;
            width: 100%;
            transition: all 0.2s ease;
        }

        .chapter_card:hover {
            cursor: pointer;
            transform: scale(1.01);
        }


        .solved_count {
            font-weight: bold;
        }

        #profile {
            margin-bottom: 10px;
        }

        #profile img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 4px solid #000000;
        }

        #email {
            margin-bottom: 20px;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .modal_content {
            background: #111;
            border: 2px solid #151515;
            border-radius: 12px;
            padding: 25px 20px;
            width: 320px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }


        .modal_content h3 {
            color: #fff;
            font-family: 'Bungee', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        #pfp_preview {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ccc;
            margin-bottom: 15px;
        }

        #pfp_input {
            width: 100%;
            color: white;
            background: #222;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
        }

        .modal_actions {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 20px;
            gap: 10px;
        }

        .btn {
            padding: 8px 18px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        .btn.cancel {
            background: #333;
            color: #ccc;
        }

        .btn.cancel:hover {
            background: #444;
        }

        .btn.save {
            background: rgb(255, 183, 0);
            color: black;
        }

        .btn.save:hover {
            background: #e6b800;
        }

        #nav-center img {
            width: 25px;
            height: 25px;
            filter: invert(1);
            cursor: pointer;
        }
    </style>
</head>

<body>

    <nav>
        <div id="logo">
            <h3>quantrank.<hi>io</hi>
            </h3>
        </div>


        <!---CENTER NAV AREA-->
        <div id="nav-center">

            <a href="{{ url_for('dashboard') }}">
                <navhi>Dashboard</navhi>
            </a>
            <a href="{{ url_for('questions') }}">
                Practice
            </a>

            <form id="logoutForm" action="{{ url_for('logout') }}" method="POST" style="display:none;"></form>

            <img src="{{ url_for('static', filename='images/logout.png') }}" alt="Logout"
                onclick="document.getElementById('logoutForm').submit();">

        </div>

        <!--RIGHT PROFILE PIC-->
        <div id="profile_pic">
            <img src="{{ profile_pic }}">
        </div>

    </nav>

    <div id="main_area">

        <div id="stats_areaU">

            <div id="profile">
                <img src="{{ profile_pic }}">
            </div>
            <div id="email">
                {{ email }}
            </div>


            <div class="info_card">
                <img src="{{ url_for('static', filename='images/points.png') }}">
                <span>NET SCORE: {{ points }}</span>
            </div>

            <div class="info_card">
                <img src="{{ url_for('static', filename='images/rank.png') }}">
                <span>RANK: {{ rank }}</span>
            </div>

            <div id="heatmap_text">
                CONSISTENCY MATRIX | TIMEZONE <time>(UTC+5:30)</time>
            </div>

            <div id="heatmap">
                <canvas id="heatmap_canvas" width="698" height="110"></canvas>
            </div>
        </div>

        <div id="right_area">
            <div id="top_stats">
                <div id="piechart">
                    <canvas id="difficultyPieChart"></canvas>
                </div>

                <div id="leaderboard_area">
                    <div id="logo_leader">
                        LEADERBOARD
                    </div>
                    {% for username, points in leaderboard %}
                    <div class="leaderboard_card">
                        <span>#{{ loop.index }}</span>
                        <span style="flex:1; text-align:center;">{{ username }}</span>
                        <span>{{ points }} pts</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div id="chapters_area">
        <h3>Chapters Solved:</h3>

        <div class="chapter_card" data-topic="ratio_proportion">
            <span>Chapter 1. Ratio and Proportion</span>
            <span class="solved_count">{{ chapter1 }} Qs</span>
        </div>

        <div class="chapter_card" data-topic="indices">
            <span>Chapter 2. Indices</span>
            <span class="solved_count">{{ chapter2 }} Qs</span>
        </div>

        <div class="chapter_card" data-topic="logarithm">
            <span>Chapter 3. Logarithm</span>
            <span class="solved_count">{{ chapter3 }} Qs</span>
        </div>

        <div class="chapter_card" data-topic="equations">
            <span>Chapter 4. Equations</span>
            <span class="solved_count">{{ chapter4 }} Qs</span>
        </div>

        <div class="chapter_card" data-topic="inequalities">
            <span>Chapter 5 Linear Inequalities</span>
            <span class="solved_count">{{ chapter5 }} Qs</span>
        </div>

        <div class="chapter_card" data-topic="finance">
            <span>Chapter 6. Mathematics of Finance</span>
            <span class="solved_count">{{ chapter6 }} Qs</span>
        </div>

        <div class="chapter_card" data-topic="permutations">
            <span>Chapter 7. Permutations and Combinations</span>
            <span class="solved_count">{{ chapter7 }} Qs</span>
        </div>

        <div class="chapter_card" data-topic="progression">
            <span>Chapter 8. Arithmetic and Geometric Progression</span>
            <span class="solved_count">{{ chapter8 }} Qs</span>
        </div>

        <div class="chapter_card" data-topic="central_tendency">
            <span>Chapter 9. Measures of Central Tendency</span>
            <span class="solved_count">{{ chapter9 }} Qs</span>
        </div>

        <div class="chapter_card" data-topic="dispersion">
            <span>Chapter 10. Dispersion</span>
            <span class="solved_count">{{ chapter10 }} Qs</span>
        </div>

        <div class="chapter_card" data-topic="correlation">
            <span>Chapter 11. Correlation and Regression</span>
            <span class="solved_count">{{ chapter11 }} Qs</span>
        </div>
    </div>


    <div id="pfp_modal" class="modal">
        <div class="modal_content">
            <h3>CHANGE PFP</h3>

            <img id="pfp_preview" src="{{ profile_pic }}">

            <form action="{{ url_for('update_pfp') }}" method="POST" enctype="multipart/form-data">
                <input id="pfp_input" type="file" name="pfp" accept="image/*" required>
                <div class="modal_actions">
                    <button type="button" class="btn cancel" onclick="closePfpModal()">Cancel</button>
                    <button type="submit" class="btn save">Save</button>
                </div>

            </form>

        </div>
    </div>




    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.2.0/dist/chartjs-chart-matrix.min.js"></script>

    <script>
        const canvas = document.getElementById('difficultyPieChart');
        const ctx = canvas.getContext('2d');

        // BACKEND VALUES
        const easy = {{ easy }};
        const medium = {{ medium }};
        const hard = {{ hard }};

        const centerTextPlugin = {
            id: 'centerText',
            beforeDraw(chart) {
                const { ctx, chartArea } = chart;
                const centerX = (chartArea.left + chartArea.right) / 2;
                const centerY = (chartArea.top + chartArea.bottom) / 2;

                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                const text = chart.$centerText || '';
                const lines = text.split('\n');

                ctx.font = '600 22px Nunito';
                ctx.fillStyle = '#ffffff';
                ctx.fillText(lines[0] || '', centerX, centerY + 10);

                ctx.font = '400 20px Nunito';
                ctx.fillStyle = '#bfbfbf';
                ctx.fillText(lines[1] || '', centerX, centerY + 30);

                ctx.restore();
            }
        };

        const total = easy + medium + hard
        const isEmpty = total == 0

        const chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: isEmpty ? ['NO DATA'] : ['EASY', 'MEDIUM', 'HARD'],
                datasets: [{
                    data: isEmpty ? [1] : [easy, medium, hard],
                    backgroundColor: isEmpty
                        ? ['#555']
                        : ['#2ecc71', '#f1c40f', '#e74c3c'],
                    borderWidth: 0,
                    hoverOffset: 20
                }]
            },
            options: {
                cutout: '60%',
                rotation: -135,
                circumference: 270,
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: 25
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            },
            plugins: [centerTextPlugin]
        });

        chart.$centerText = isEmpty ? 'NO DATA' : `TOTAL\n ${total}`;
        chart.draw();

        if (!isEmpty) {
            canvas.addEventListener('mousemove', (event) => {
                const elements = chart.getElementsAtEventForMode(
                    event,
                    'nearest',
                    { intersect: true },
                    false
                );

                if (elements.length) {
                    const index = elements[0].index;
                    const label = chart.data.labels[index];
                    const value = chart.data.datasets[0].data[index];
                    chart.$centerText = `${label}\n${value}`;
                } else {
                    chart.$centerText = `TOTAL\n${total}`;
                }

                chart.draw();
            });

            canvas.addEventListener('mouseleave', () => {
                chart.$centerText = `TOTAL\n${total}`;
                chart.draw();
            });
        }


        (() => {
            const canvas = document.getElementById('heatmap_canvas');
            const HEATMAP_DATA = {{ heatmap_data | tojson
        }};
        const ctx = canvas.getContext('2d');

        const COLS = 50;
        const ROWS = 8;
        const CELL = 10;
        const GAP = 4;
        const RADIUS = 2;

        const dates = Object.keys(HEATMAP_DATA).sort();
        const pointsArray = dates.map(d => HEATMAP_DATA[d]);


        const values = Array.from({ length: ROWS }, () => Array(COLS).fill(0));

        for (let i = 0; i < COLS * ROWS; i++) {
            const col = Math.floor(i / ROWS);
            const row = i % ROWS;
            if (i < pointsArray.length) values[row][col] = pointsArray[i];
        }
        function getHeatColor(value) {
            if (value <= 0) return 'rgba(40, 40, 40, 1)';
            const max = 20;
            const intensity = Math.min(value, max) / max;
            const r = Math.floor(46 * (0.3 + 0.7 * intensity));
            const g = Math.floor(204 * (0.3 + 0.7 * intensity));
            const b = Math.floor(113 * (0.3 + 0.7 * intensity));
            return `rgb(${r}, ${g}, ${b})`;
        }

        function roundRect(x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r);
            ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.closePath();
            ctx.fill();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    const idx = y + x * ROWS;

                    const date = dates[idx];    
                    if (!date) continue;      

                    const value = pointsArray[idx] || 0;
                    const px = x * (CELL + GAP);
                    const py = y * (CELL + GAP);
                    if (value === 0) {
                        ctx.fillStyle = 'rgba(40, 40, 40, 1)';
                    }
                    else {
                        ctx.fillStyle = getHeatColor(value);
                    }

                    roundRect(px, py, CELL, CELL, RADIUS);
                }
            }
        }



        draw();

        const tooltip = document.createElement('div');
        tooltip.style.position = 'absolute';
        tooltip.style.padding = '6px 10px';
        tooltip.style.background = '#222';
        tooltip.style.color = '#fff';
        tooltip.style.borderRadius = '4px';
        tooltip.style.border = '1.5px solid #fff';
        tooltip.style.fontSize = '14px';
        tooltip.style.pointerEvents = 'none';
        tooltip.style.transition = '0.1s';
        tooltip.style.opacity = 0;
        document.body.appendChild(tooltip);

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            let found = false;

            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    const idx = y + x * ROWS;
                    const value = pointsArray[idx];

                    const date = dates[idx];
                    if (!date) continue;


                    const px = x * (CELL + GAP);
                    const py = y * (CELL + GAP);

                    if (mouseX >= px && mouseX <= px + CELL && mouseY >= py && mouseY <= py + CELL) {
                        const date = dates[idx] || 'N/A';
                        tooltip.innerText =
                            value === 0
                                ? `No activity on ${date}`
                                : `Points: ${value} on ${date}`;

                        tooltip.style.left = `${rect.left + mouseX + 10}px`;
                        tooltip.style.top = `${rect.top + mouseY + 10}px`;
                        tooltip.style.opacity = 1;
                        canvas.style.cursor = 'pointer';
                        found = true;
                        break;
                    }
                }
                if (found) break;
            }

            if (!found) {
                tooltip.style.opacity = 0;
                canvas.style.cursor = 'default';
            }
        });

}) ();


        const modal = document.getElementById("pfp_modal");
        const preview = document.getElementById("pfp_preview");
        const input = document.getElementById("pfp_input");

        document.querySelectorAll("#profile img, #profile_pic img").forEach(img => {
            img.addEventListener("click", () => {
                modal.style.display = "flex";
            });
        });

        function closePfpModal() {
            modal.style.display = "none";
            input.value = "";
        }

        input.addEventListener("change", () => {
            const file = input.files[0];
            if (file) {
                preview.src = URL.createObjectURL(file);
            }
        });

        modal.addEventListener("click", e => {
            if (e.target === modal) closePfpModal();
        });


    </script>

</body>

</html>